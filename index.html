# Fix and re-create the unified installer without syntax errors.
from pathlib import Path
import os

base = Path("/mnt/data")
index_code = (base / "index.py").read_text(encoding="utf-8")
requirements = (base / "requirements.txt").read_text(encoding="utf-8")

template = r"""#!/usr/bin/env bash
set -Eeuo pipefail

# === Jarvis Dominion â€” ONE INSTALLER (index + ubuntu) ===
# Installs system deps, creates /opt/primal_dominion/jarvis_bot,
# writes index.py + requirements.txt, sets up venv, downloads Vosk model,
# creates systemd service, and starts Jarvis.
#
# Usage:
#   sudo bash setup_index_ubuntu.sh
#
# Optional flags:
#   --skip-model  : do not download Vosk model (set VOSK_MODEL yourself)
#   --no-service  : do not create/start the systemd service
#   --dev         : don't install to /opt, just drop files in $PWD and exit

APP_DIR="/opt/primal_dominion/jarvis_bot"
SERVICE_NAME="jarvis"
TARGET_USER="${SUDO_USER:-$(logname 2>/dev/null || echo root)}"
TARGET_HOME="$(getent passwd "$TARGET_USER" | cut -d: -f6 || echo "/root")"
VOSK_MODEL_DIR="$TARGET_HOME/models"
VOSK_MODEL_NAME="vosk-model-small-en-us-0.15"
VOSK_MODEL_URL="https://alphacephei.com/vosk/models/${VOSK_MODEL_NAME}.zip"

DO_MODEL=1
DO_SERVICE=1
DEV_MODE=0

for arg in "$@"; do
  case "$arg" in
    --skip-model) DO_MODEL=0 ;;
    --no-service) DO_SERVICE=0 ;;
    --dev) DEV_MODE=1 ;;
    *) echo "Unknown option: $arg" >&2; exit 2;;
  esac
done

if [[ $EUID -ne 0 ]]; then
  echo "Run with sudo: sudo bash setup_index_ubuntu.sh" >&2
  exit 1
fi

echo "[1/8] Installing Ubuntu packages..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y python3 python3-venv python3-pip python3-dev build-essential \
                   portaudio19-dev ffmpeg libsndfile1 unzip wget

if [[ "$DEV_MODE" -eq 1 ]]; then
  echo "[DEV] Writing index.py and requirements.txt to $PWD ..."
  cat > index.py <<'PYCODE'
__INDEX_CODE__
PYCODE

  cat > requirements.txt <<'REQS'
__REQUIREMENTS__
REQS

  echo "Dev mode complete. Activate a venv and pip install -r requirements.txt, then run: python index.py"
  exit 0
fi

echo "[2/8] Creating app directory at $APP_DIR ..."
mkdir -p "$APP_DIR"

echo "[3/8] Writing index.py and requirements.txt..."
install -m 0644 /dev/stdin "$APP_DIR/index.py" <<'PYCODE'
__INDEX_CODE__
PYCODE

install -m 0644 /dev/stdin "$APP_DIR/requirements.txt" <<'REQS'
__REQUIREMENTS__
REQS

echo "[4/8] Creating Python venv and installing deps..."
if [[ ! -d "$APP_DIR/venv" ]]; then
  python3 -m venv "$APP_DIR/venv"
fi
source "$APP_DIR/venv/bin/activate"
pip install --upgrade pip wheel setuptools
pip install -r "$APP_DIR/requirements.txt"

if [[ "$DO_MODEL" -eq 1 ]]; then
  echo "[5/8] Downloading Vosk model to $VOSK_MODEL_DIR/$VOSK_MODEL_NAME ..."
  mkdir -p "$VOSK_MODEL_DIR"
  cd "$VOSK_MODEL_DIR"
  if [[ ! -d "$VOSK_MODEL_NAME" ]]; then
    wget -q --show-progress "$VOSK_MODEL_URL"
    unzip -q "${VOSK_MODEL_NAME}.zip"
  fi
  chown -R "$TARGET_USER":"$TARGET_USER" "$VOSK_MODEL_DIR"
else
  echo "[5/8] Skipping Vosk model download (--skip-model)"
fi

echo "[6/8] Ensuring environment files exist..."
mkdir -p "$TARGET_HOME/.jarvis"
if [[ ! -f "$TARGET_HOME/.jarvis/.env" ]]; then
  echo 'OPENAI_API_KEY=' > "$TARGET_HOME/.jarvis/.env"
  chown "$TARGET_USER":"$TARGET_USER" "$TARGET_HOME/.jarvis/.env"
  chmod 600 "$TARGET_HOME/.jarvis/.env"
fi
if [[ ! -f "$APP_DIR/.env" ]]; then
  echo 'OPENAI_API_KEY=' > "$APP_DIR/.env"
  chmod 600 "$APP_DIR/.env"
fi

echo "[7/8] Creating systemd service (user=$SERVICE_NAME@$TARGET_USER) ..."
if [[ "$DO_SERVICE" -eq 1 ]]; then
  cat > /etc/systemd/system/${SERVICE_NAME}@.service <<'UNIT'
[Unit]
Description=Jarvis Dominion Voice AI
After=sound.target network-online.target
Wants=network-online.target

[Service]
Type=simple
User=%i
Environment=VOSK_MODEL=/home/%i/models/vosk-model-small-en-us-0.15
EnvironmentFile=-/home/%i/.jarvis/.env
EnvironmentFile=-/opt/primal_dominion/jarvis_bot/.env
WorkingDirectory=/opt/primal_dominion/jarvis_bot
ExecStart=/opt/primal_dominion/jarvis_bot/venv/bin/python /opt/primal_dominion/jarvis_bot/index.py
Restart=on-failure
RestartSec=3
StandardOutput=append:/opt/primal_dominion/jarvis_bot/jarvis.log
StandardError=append:/opt/primal_dominion/jarvis_bot/jarvis.log

[Install]
WantedBy=default.target
UNIT

  systemctl daemon-reload
  systemctl enable ${SERVICE_NAME}@"$TARGET_USER"
  systemctl restart ${SERVICE_NAME}@"$TARGET_USER" || systemctl start ${SERVICE_NAME}@"$TARGET_USER"
  echo "Service status:"
  systemctl --no-pager --full status ${SERVICE_NAME}@"$TARGET_USER" || true
else
  echo "[skip] --no-service was set; not creating/starting systemd unit."
fi

echo "[8/8] Done."
echo
echo "Run manually (without service):"
echo "  source $APP_DIR/venv/bin/activate"
echo "  VOSK_MODEL=$VOSK_MODEL_DIR/$VOSK_MODEL_NAME python $APP_DIR/index.py"
echo
echo "If you used the service, tail logs:"
echo "  sudo journalctl -u ${SERVICE_NAME}@$TARGET_USER -f"
"""

# Perform placeholder substitution
installer = template.replace("__INDEX_CODE__", index_code).replace("__REQUIREMENTS__", requirements)

setup_path = base / "setup_index_ubuntu.sh"
setup_path.write_text(installer, encoding="utf-8")
os.chmod(setup_path, 0o755)

str(setup_path)
